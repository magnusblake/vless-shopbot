{% extends "base.html" %}
{% block title %}Главная страница{% endblock %}
{% block content %}

<div class="space-y-6">
	<div>
		<h1 class="text-3xl font-bold tracking-tight">Dashboard</h1>
		<p class="text-muted-foreground mt-1">Обзор основных метрик вашей системы</p>
	</div>

	<div class="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
		<div class="rounded-lg border border-border bg-card p-6 shadow-sm transition-all hover:shadow-md">
			<div class="flex flex-row items-center justify-between space-y-0 pb-2">
				<h3 class="text-sm font-medium text-muted-foreground">Пользователей</h3>
				<svg class="h-4 w-4 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
				</svg>
			</div>
			<div class="mt-3">
				<div class="text-3xl font-bold">{{ stats.user_count }}</div>
			</div>
		</div>

		<div class="rounded-lg border border-border bg-card p-6 shadow-sm transition-all hover:shadow-md">
			<div class="flex flex-row items-center justify-between space-y-0 pb-2">
				<h3 class="text-sm font-medium text-muted-foreground">Всего ключей</h3>
				<svg class="h-4 w-4 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
				</svg>
			</div>
			<div class="mt-3">
				<div class="text-3xl font-bold">{{ stats.total_keys }}</div>
			</div>
		</div>

		<div class="rounded-lg border border-border bg-card p-6 shadow-sm transition-all hover:shadow-md">
			<div class="flex flex-row items-center justify-between space-y-0 pb-2">
				<h3 class="text-sm font-medium text-muted-foreground">Всего потрачено</h3>
				<svg class="h-4 w-4 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
				</svg>
			</div>
			<div class="mt-3">
				<div class="text-3xl font-bold">{{ stats.total_spent | round(2) }}</div>
				<p class="text-xs text-muted-foreground mt-1">RUB</p>
			</div>
		</div>

		<div class="rounded-lg border border-border bg-card p-6 shadow-sm transition-all hover:shadow-md">
			<div class="flex flex-row items-center justify-between space-y-0 pb-2">
				<h3 class="text-sm font-medium text-muted-foreground">Активных хостов</h3>
				<svg class="h-4 w-4 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01"></path>
				</svg>
			</div>
			<div class="mt-3">
				<div class="text-3xl font-bold">{{ stats.host_count }}</div>
			</div>
		</div>
	</div>

	<div class="grid gap-6 lg:grid-cols-3">
		<div class="lg:col-span-2 space-y-6">
			<div class="rounded-lg border border-border bg-card p-6 shadow-sm">
				<h2 class="text-xl font-semibold mb-4">Аналитика за последние 30 дней</h2>
				<div class="space-y-6">
					<div>
						<h3 class="text-sm font-medium text-muted-foreground mb-3">Новые пользователи</h3>
						<div class="h-[250px]">
							<canvas id="newUsersChart"></canvas>
						</div>
					</div>
					<div>
						<h3 class="text-sm font-medium text-muted-foreground mb-3">Новые ключи</h3>
						<div class="h-[250px]">
							<canvas id="newKeysChart"></canvas>
						</div>
					</div>
				</div>
			</div>
		</div>

		<div>
			<div class="rounded-lg border border-border bg-card p-6 shadow-sm">
				<h2 class="text-xl font-semibold mb-4">Недавние транзакции</h2>
				{% if transactions %}
				<div class="space-y-3">
					{% for tx in transactions %}
					<div class="rounded-md border border-border bg-secondary/50 p-3 text-sm transition-colors hover:bg-secondary">
						<div class="flex justify-between items-start mb-2">
							<div class="font-medium">{{ tx.username or 'N/A' }}</div>
							<div class="text-xs text-muted-foreground">{{ tx.created_date.split(' ')[0] }}</div>
						</div>
						<div class="text-xs text-muted-foreground space-y-1">
							<div>ID: {{ tx.user_id }}</div>
							<div>Хост: {{ tx.host_name }}</div>
							<div>План: {{ tx.plan_name }}</div>
							<div class="font-medium text-foreground mt-2">{{ tx.amount_rub | round(2) }} RUB</div>
						</div>
					</div>
					{% endfor %}
				</div>

				{% if total_pages > 1 %}
				<nav class="flex items-center justify-center space-x-2 mt-6">
					<a
						href="{{ url_for('dashboard_page', page=current_page - 1) }}"
						class="inline-flex items-center justify-center rounded-md h-8 w-8 text-sm font-medium transition-colors hover:bg-accent hover:text-accent-foreground {% if current_page == 1 %}pointer-events-none opacity-50{% endif %}"
					>
						<svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
						</svg>
					</a>

					{% for p in range(1, total_pages + 1) %}
					<a
						href="{{ url_for('dashboard_page', page=p) }}"
						class="inline-flex items-center justify-center rounded-md h-8 w-8 text-sm font-medium transition-colors hover:bg-accent hover:text-accent-foreground {% if p == current_page %}bg-primary text-primary-foreground hover:bg-primary/90{% endif %}"
					>
						{{ p }}
					</a>
					{% endfor %}

					<a
						href="{{ url_for('dashboard_page', page=current_page + 1) }}"
						class="inline-flex items-center justify-center rounded-md h-8 w-8 text-sm font-medium transition-colors hover:bg-accent hover:text-accent-foreground {% if current_page == total_pages %}pointer-events-none opacity-50{% endif %}"
					>
						<svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
						</svg>
					</a>
				</nav>
				{% endif %}
				{% else %}
				<p class="text-sm text-muted-foreground text-center py-8">Пока нет транзакций для отображения</p>
				{% endif %}
			</div>
		</div>
	</div>
</div>

<script>
	const CHART_DATA = {{ chart_data | tojson }};
</script>

{% endblock %}
